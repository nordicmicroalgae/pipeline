---
title: "update-nua-taxonomy"
author: "Anders Torstensson"
date: "`r Sys.Date()`"
output: html_document
params: 
  cache_taxa_worms: TRUE # Run on cached data from WoRMS
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reticulate)
library(tidyverse)

if(file.exists("code/dyntaxa_subscription_key.R")) {
  source("code/dyntaxa_subscription_key.R")
} else {
  subscription_key <- rstudioapi::askForPassword(prompt = "Please enter your SLU Artdatabanken API key")
}
```

# Get current aphia ids for taxa list (NOMP + old checklist)

```{r update_checklist, message=FALSE}
source("code/01_update_used_aphia_id_list.R")
```

# Create taxa_worms.txt, including higher taxonomy, using
https://github.com/nordicmicroalgae/taxa-worms

```{r get_taxa_file, message=FALSE, warning=FALSE}
if(!params$cache_taxa_worms) {
  file.remove("worms_cache.db")
}

py_run_file("../taxa-worms/extract_from_worms_main.py")
```

# Get all synonyms from WoRMS and find duplcated taxa, potential errors can be deleted

```{r synonyms, message=FALSE}
source("code/02_get_worms_synonyms.R")

kableExtra::kable(duplicates)
```

# Remove duplicates manually from taxa file

```{r clean_taxa}
# Read taxa_worms file and remove unwanted taxa
taxa_worms <- read_tsv("data_out/content/taxa.txt") %>%
  filter(!taxon_id %in% c(599656,
                          582161))

write_tsv(taxa_worms, "data_out/content/taxa.txt", na = "") 
```

# Match taxa with Dyntaxa

```{r match_dyntaxa}
source("code/03_match_worms_and_dyntaxa.R")
```

# Export files to send to AlgaeBase

```{r export_algaebase}
source("code/04_export_algaebase.R")
```

# Extract culture information from NORCCA using 
https://github.com/nordicmicroalgae/norcca_compiler

```{r get_norcca, message=FALSE}
setwd("../norcca_compiler/norcca_compiler")

system("venv\\Scripts\\activate")

system("pip install beautifulsoup4")
system("pip install requests")

system("python -m norcca_compiler --output norcca_strains.txt")

norcca <- read_tsv("norcca_strains.txt")

setwd(here::here())

write_delim(norcca, "data_in/norcca_strains.txt", 
            delim = "\t",
            na = "")
```

# Reformat NORCCA list and add taxon_id

```{r wrangle_norcca}
source("code/05_wrangle_norcca.R")
```

# Reformat IOC HAB list and add taxon_id
# Downloaded (Text file, tab delimited (TXT)) from
https://www.marinespecies.org/hab/aphia.php?p=download&what=taxlist

```{r wrangle_hab_list}
source("code/06_wrangle_hab.R")
```